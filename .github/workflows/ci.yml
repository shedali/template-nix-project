name: CI
on: [push, pull_request]
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: DeterminateSystems/nix-installer-action@v14
    - uses: cachix/cachix-action@v14
      with:
        name: shedali
        authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
    - run: nix fmt --accept-flake-config -- --check
    - run: nix build --accept-flake-config
    - run: nix flake check --accept-flake-config
    - name: Security Scan
      run: |
        nix develop --accept-flake-config --command bash -c "
          echo 'ğŸ” Running security scans on CI...'
          
          echo 'ğŸ“¦ Scanning Bun dependencies...'
          if bun audit --json > /dev/null 2>&1; then
            echo 'âœ… Bun audit passed'
          else
            echo 'âš ï¸  Bun audit found issues:'
            bun audit || true
          fi
          
          echo 'ğŸ” Scanning Nix derivation for vulnerabilities...'
          if vulnix -S \$(realpath result) 2>/dev/null | grep -q 'Found vulnerable packages'; then
            echo 'âš ï¸  Vulnerabilities found in Nix packages:'
            vulnix -S \$(realpath result)
            exit 1
          else
            echo 'âœ… No known vulnerabilities in Nix packages'
          fi
          
          echo 'ğŸ”‘ Basic secret scanning...'
          if grep -r -i -E '(password|secret|key|token)' src/ --exclude-dir=node_modules 2>/dev/null | grep -v 'getElementById'; then
            echo 'âš ï¸  Potential secrets found in source code'
            exit 1
          else
            echo 'âœ… No obvious secrets found in source code'
          fi
          
          echo 'ğŸ” Security scan complete - all checks passed'
        "